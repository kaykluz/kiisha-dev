{
  "title": "Portfolio Overview",
  "uid": null,
  "tags": ["kiisha", "portfolio", "overview"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "5m",
  "templating": {
    "list": [
      {
        "name": "org_id",
        "type": "constant",
        "hide": 2,
        "current": { "value": "${org_id}", "text": "${org_id}" }
      },
      {
        "name": "project_id",
        "type": "query",
        "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
        "query": "SELECT DISTINCT project_id FROM normalized_measurements WHERE organization_id = ${org_id}",
        "multi": true,
        "includeAll": true,
        "allValue": "*"
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "Total Energy Production (kWh)",
      "type": "stat",
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT SUM(value) as value FROM normalized_measurements WHERE organization_id = ${org_id} AND metric_name = 'energy_production' AND timestamp >= NOW() - INTERVAL 30 DAY AND ($project_id = '*' OR project_id IN (${project_id:csv}))",
          "format": "table"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "kwatth",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 1000 },
              { "color": "green", "value": 5000 }
            ]
          }
        }
      }
    },
    {
      "id": 2,
      "title": "Active Sites",
      "type": "stat",
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT COUNT(DISTINCT site_id) as value FROM normalized_measurements WHERE organization_id = ${org_id} AND timestamp >= NOW() - INTERVAL 1 DAY AND ($project_id = '*' OR project_id IN (${project_id:csv}))",
          "format": "table"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "blue", "value": null }
            ]
          }
        }
      }
    },
    {
      "id": 3,
      "title": "Active Alerts",
      "type": "stat",
      "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT COUNT(*) as value FROM alert_events WHERE organization_id = ${org_id} AND status IN ('open', 'acknowledged') AND ($project_id = '*' OR project_id IN (${project_id:csv}))",
          "format": "table"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 5 },
              { "color": "red", "value": 10 }
            ]
          }
        }
      }
    },
    {
      "id": 4,
      "title": "System Health",
      "type": "gauge",
      "gridPos": { "x": 18, "y": 0, "w": 6, "h": 4 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT AVG(CASE WHEN status = 'online' THEN 100 ELSE 0 END) as value FROM devices WHERE organization_id = ${org_id} AND ($project_id = '*' OR project_id IN (${project_id:csv}))",
          "format": "table"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 80 },
              { "color": "green", "value": 95 }
            ]
          }
        }
      }
    },
    {
      "id": 5,
      "title": "Energy Production Over Time",
      "type": "timeseries",
      "gridPos": { "x": 0, "y": 4, "w": 24, "h": 8 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT timestamp as time, SUM(value) as value, 'Total Production' as metric FROM normalized_measurements WHERE organization_id = ${org_id} AND metric_name = 'energy_production' AND timestamp >= NOW() - INTERVAL 7 DAY AND ($project_id = '*' OR project_id IN (${project_id:csv})) GROUP BY DATE(timestamp), HOUR(timestamp) ORDER BY time",
          "format": "time_series"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "kwatth",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 20,
            "gradientMode": "opacity"
          }
        }
      }
    },
    {
      "id": 6,
      "title": "Production by Site",
      "type": "piechart",
      "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT s.name as metric, SUM(nm.value) as value FROM normalized_measurements nm JOIN sites s ON nm.site_id = s.id WHERE nm.organization_id = ${org_id} AND nm.metric_name = 'energy_production' AND nm.timestamp >= NOW() - INTERVAL 30 DAY AND ($project_id = '*' OR nm.project_id IN (${project_id:csv})) GROUP BY s.id, s.name ORDER BY value DESC LIMIT 10",
          "format": "table"
        }
      ]
    },
    {
      "id": 7,
      "title": "Recent Alerts",
      "type": "table",
      "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
      "datasource": { "type": "mysql", "uid": "${datasource_uid}" },
      "targets": [
        {
          "rawSql": "SELECT ae.created_at as 'Time', ar.name as 'Alert', ae.severity as 'Severity', ae.status as 'Status', p.name as 'Project' FROM alert_events ae LEFT JOIN alert_rules ar ON ae.alert_rule_id = ar.id LEFT JOIN projects p ON ae.project_id = p.id WHERE ae.organization_id = ${org_id} AND ($project_id = '*' OR ae.project_id IN (${project_id:csv})) ORDER BY ae.created_at DESC LIMIT 20",
          "format": "table"
        }
      ],
      "fieldConfig": {
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Severity" },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background",
                  "mode": "basic"
                }
              },
              {
                "id": "mappings",
                "value": [
                  { "type": "value", "options": { "critical": { "color": "red" } } },
                  { "type": "value", "options": { "high": { "color": "orange" } } },
                  { "type": "value", "options": { "medium": { "color": "yellow" } } },
                  { "type": "value", "options": { "low": { "color": "blue" } } }
                ]
              }
            ]
          }
        ]
      }
    }
  ]
}
